name: "Pull Request Preview ðŸ‘€"

on:
  pull_request_target:
    branches: [ master ]
    types: [ labeled ]
  workflow_run:
    workflows: ["Pull Request Checker ðŸ›ƒ"]
    types:
      - completed
      - requested

jobs:
  preview-netlify:
    name: "Netlify preview ðŸ‘€"
    runs-on: ubuntu-latest
    needs: [ build ]
    if: contains( github.event.pull_request.labels.*.name, 'preview')

    steps:
    - name: Download artifact from build workflow
      uses: dawidd6/action-download-artifact@v2
      with:
        name: pr-build-website
        pr: ${{ github.event.pull_request.number }}
        workflow: pr_checker_build.yml
        workflow_conclusion: completed,success

    # - name: Download previously build artifact
    #   uses: actions/download-artifact@v2
    #   with:
    #     name: pr-build-website

    - name: Deploy preview to Netlify
      uses: nwtgck/actions-netlify@v1.2
      with:
        alias: deploy-preview-${{ github.event.number }}
        deploy-message: "Deploy preview of PR ${{ github.event.pull_request.title }} from GitHub Actions"
        enable-commit-comment: false
        enable-pull-request-comment: true
        fails-without-credentials: true
        github-token: ${{ secrets.GITHUB_TOKEN }}
        overwrites-pull-request-comment: true
        production-branch: master
        production-deploy: false
        publish-dir: '.'
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      timeout-minutes: 10
